<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ayo Coba TKA | Simulasi SD</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Roboto', sans-serif; 
            background-color: #003399; /* Biru Royal Persib */
            background-attachment: fixed;
        }
        .bg-royal { background-color: #003399; }
        .btn-ok { background-color: #f6931d; color: white; border-bottom: 4px solid #c87100; transition: all 0.1s; }
        .btn-ok:active { transform: translateY(2px); border-bottom-width: 2px; }
        .option-card:hover { border-color: #3b82f6; background-color: #eff6ff; }
        .option-selected { border-color: #2563eb !important; background-color: #dbeafe !important; border-width: 2px; }
        .btn-ragu-active { background-color: #facc15 !important; color: black; }
        .grid-number { transition: all 0.2s; cursor: pointer; }
        .status-answered { background-color: #2563eb; color: white; }
        .status-doubt { background-color: #facc15; color: black; }
        .status-current { border: 2px solid #2563eb; }
        
        .card-pusmendik { background: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
        }

        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="min-h-screen overflow-x-hidden text-gray-800 text-left">

    <header class="bg-white p-3 shadow-md sticky top-0 z-50 text-left">
        <div class="container mx-auto flex justify-between items-center text-left">
            <div class="flex items-center gap-2 md:gap-4 text-left">
                <!-- Logo Sekolah User -->
                <img src="https://github.com/racketboys-pe/abseneskulbola/blob/main/Copy%20of%20RAPAT%20SEKOLAH%20SEMESTER%202%20(1).png?raw=true" alt="Logo Sekolah" class="h-8 md:h-10 w-auto object-contain">
                <div class="h-6 w-[1px] bg-gray-300"></div>
                <div class="text-[#003399] text-left">
                    <h1 class="font-black text-xl md:text-2xl leading-tight uppercase tracking-tighter">TKA</h1>
                </div>
            </div>
            
            <div class="flex items-center gap-4 text-right">
                <div id="userInfo" class="hidden md:block text-right text-gray-800">
                    <p class="text-sm font-bold text-gray-800"><span id="displayStudentName">Siswa</span></p>
                    <p class="text-[10px] text-[#003399] font-bold uppercase" id="displaySubjectInfo">Mata Uji</p>
                </div>
                <button id="adminLoginBtn" onclick="toggleAdminLogin(true)" class="text-gray-300 hover:text-blue-600 p-2 transition-all">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                </button>
                <button id="exitAdminBtn" onclick="showView('landingPage')" class="hidden bg-red-600 hover:bg-red-700 px-4 py-2 rounded text-white text-xs font-bold uppercase transition-all shadow-md">
                    Keluar Admin
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 md:py-12 text-left">
        
        <div id="loader" class="fixed inset-0 bg-white/80 z-[200] flex items-center justify-center hidden text-center">
            <div>
                <div class="animate-spin rounded-full h-12 w-12 border-4 border-[#003399] border-t-transparent mx-auto mb-4"></div>
                <p id="loaderText" class="text-sm font-bold text-[#003399]">Mohon Tunggu...</p>
            </div>
        </div>

        <!-- PAGE 1: LANDING -->
        <section id="landingPage" class="max-w-md mx-auto glass-card overflow-hidden transition-all fade-in text-left">
            <div class="p-0 overflow-hidden rounded-t-2xl">
                <img src="https://i.pinimg.com/736x/1b/2b/8b/1b2b8b91c8ed8a7e1e45698345a68387.jpg" alt="Ayo Coba TKA" class="w-full h-auto object-cover">
            </div>
            <div class="p-8 text-center text-white">
                <h2 class="text-xl font-black mb-6 uppercase tracking-tight">Mulai Simulasi TKA</h2>
                <div class="space-y-4 text-left">
                    <div>
                        <label class="block text-sm font-bold text-white/80 mb-1">Pilih Mata Uji</label>
                        <select id="subjectSelect" class="w-full p-3 bg-white/20 border border-white/30 rounded-md text-white outline-none font-medium">
                            <option value="Bahasa Indonesia" class="text-gray-800">Literasi (Bahasa Indonesia)</option>
                            <option value="Matematika" class="text-gray-800">Numerasi (Matematika)</option>
                        </select>
                    </div>
                    <div class="pt-4">
                        <button onclick="goToConfirmation()" class="w-full btn-ok font-black py-4 rounded-md text-xl tracking-widest uppercase shadow-xl">OK!</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- PAGE 2: KONFIRMASI -->
        <section id="loginPage" class="hidden max-w-lg mx-auto card-pusmendik p-10 transition-all fade-in text-center text-gray-800">
            <div class="border-b border-gray-100 pb-4 mb-8 text-center text-gray-800">
                <h2 class="text-2xl font-black text-[#003399] uppercase tracking-tight">Konfirmasi Data Peserta</h2>
            </div>
            <div class="space-y-6 text-left">
                <div class="flex flex-col md:flex-row gap-4 items-center">
                    <div class="w-full md:w-1/3 text-gray-500 font-bold text-xs uppercase tracking-wider text-right">Nama Lengkap</div>
                    <div class="flex-1 w-full"><input type="text" id="studentName" placeholder="Masukkan Nama Peserta" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-lg font-bold text-gray-800 outline-none focus:ring-2 focus:ring-blue-400"></div>
                </div>
                <div class="flex flex-col md:flex-row gap-4 items-center text-left">
                    <div class="w-full md:w-1/3 text-gray-500 font-bold text-xs uppercase tracking-wider text-right">Mata Uji</div>
                    <div class="flex-1 w-full"><input type="text" id="displaySubjectName" readonly class="w-full p-4 bg-gray-100 border border-gray-200 rounded-lg text-[#003399] font-black outline-none" value=""></div>
                </div>
                <div class="flex flex-col md:flex-row gap-4 items-center text-center">
                    <div class="w-full md:w-1/3 text-gray-500 font-bold text-xs uppercase tracking-wider text-right text-gray-800">Token</div>
                    <div class="flex-1 w-full"><input type="text" id="tokenInput" placeholder="READY24" class="w-full p-4 bg-white border border-gray-200 rounded-lg font-mono text-center tracking-[12px] uppercase font-black text-2xl text-blue-600 outline-none focus:ring-2 focus:ring-blue-400"></div>
                </div>
                <div class="pt-8 flex justify-center text-gray-800">
                    <button onclick="prepareExam()" class="bg-[#003399] text-white hover:bg-blue-800 font-black px-24 py-4 rounded-xl shadow-xl transition-all uppercase tracking-widest transform active:scale-95">MASUK</button>
                </div>
            </div>
        </section>

        <!-- PAGE 3: AREA UJIAN -->
        <section id="examPage" class="hidden flex flex-col lg:flex-row gap-6 fade-in text-gray-800 text-left text-left">
            <div class="flex-1 space-y-4 text-left">
                <div class="bg-white rounded-xl shadow-lg border p-6 min-h-[450px] relative text-left">
                    <div class="flex justify-between items-center mb-6 border-b pb-4 text-left">
                        <div class="flex items-center gap-3 text-left">
                            <span class="bg-[#003399] text-white px-4 py-1.5 rounded-lg text-sm font-black uppercase">SOAL <span id="currentNumberText">1</span></span>
                            <span id="questionTypeBadge" class="text-[10px] font-bold uppercase px-2 py-0.5 rounded bg-gray-100 text-gray-400 border italic">PG</span>
                        </div>
                        <div class="flex gap-2 items-center text-xs text-gray-400 text-right">
                            <span id="currentPackageInfo" class="bg-gray-100 px-2 py-1 rounded font-bold"></span>
                            <div class="flex border rounded overflow-hidden">
                                <button onclick="changeFontSize('text-base')" class="px-3 py-1 bg-gray-50 hover:bg-gray-200 font-bold border-r">A</button>
                                <button onclick="changeFontSize('text-xl')" class="px-3 py-1 bg-gray-50 hover:bg-gray-200 font-bold border-r">A</button>
                                <button onclick="changeFontSize('text-2xl')" class="px-3 py-1 bg-gray-50 hover:bg-gray-200 font-bold text-lg">A</button>
                            </div>
                        </div>
                    </div>
                    <div id="questionImageBox" class="hidden mb-6 flex justify-center bg-gray-50 p-4 rounded-xl border border-dashed text-gray-800 text-center">
                        <img id="questionImageDisplay" src="" class="max-h-64 object-contain shadow-sm rounded-lg">
                    </div>
                    <div id="questionContent" class="text-gray-800 leading-relaxed text-xl mb-10 min-h-[100px] text-left"></div>
                    <div id="optionsContainer" class="space-y-3 text-gray-800 text-left"></div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-lg border flex flex-wrap justify-between items-center gap-4 text-gray-800 text-left">
                    <button id="btnPrev" onclick="prevQuestion()" class="flex-1 md:flex-none bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-3 px-8 rounded-lg border transition-all disabled:opacity-30 uppercase text-xs">Sebelumnya</button>
                    <button id="btnRagu" onclick="toggleDoubtful()" class="flex-1 md:flex-none bg-yellow-400 hover:bg-yellow-500 text-black font-bold py-3 px-8 rounded-lg transition-all uppercase text-xs text-gray-800">Ragu-ragu</button>
                    <button id="btnNext" onclick="nextQuestion()" class="flex-1 md:flex-none bg-[#003399] hover:bg-blue-800 text-white font-bold py-3 px-8 rounded-lg transition-all shadow-md uppercase text-xs text-white">Berikutnya</button>
                </div>
            </div>
            <div class="lg:w-80 space-y-4 text-left">
                <div class="bg-white rounded-xl shadow-lg border p-6 text-center text-gray-800 text-left">
                    <p class="text-[10px] text-gray-400 font-black uppercase tracking-widest mb-1 text-center">Sisa Waktu</p>
                    <div id="timer" class="text-4xl font-black text-[#003399] tabular-nums text-center">00:00</div>
                </div>
                <div class="bg-white rounded-xl shadow-lg border p-6 text-gray-700 text-left">
                    <div class="flex justify-between items-center mb-4 border-b pb-2 text-left">
                        <h3 class="font-bold uppercase text-xs text-gray-800">Daftar Soal</h3>
                        <span id="progressText" class="text-xs bg-gray-100 px-2 py-1 rounded-md font-bold text-gray-800">0/0</span>
                    </div>
                    <div id="questionGrid" class="grid grid-cols-5 gap-2 text-gray-800 text-left"></div>
                    <button onclick="confirmFinish()" class="w-full mt-6 bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded-lg shadow-lg uppercase text-xs transform active:scale-95 text-white">Selesai Tes</button>
                </div>
            </div>
        </section>

        <!-- PAGE 4: HASIL -->
        <section id="resultPage" class="hidden max-w-2xl mx-auto card-pusmendik p-10 text-center fade-in text-gray-800 text-left text-center">
            <div class="w-24 h-24 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-sm text-gray-800">
                <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
            </div>
            <h2 class="text-3xl font-black mb-1 uppercase tracking-tight text-gray-800">Hasil Tes Selesai</h2>
            <p id="resultMsg" class="text-gray-500 mb-8 font-medium italic text-gray-800">Menyimpan rincian nilai...</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8 text-gray-800 text-left">
                <div class="bg-[#003399] p-8 rounded-xl text-white shadow-xl text-center">
                    <p class="text-xs font-bold uppercase tracking-widest opacity-80 mb-2">Skor Kamu</p>
                    <p id="finalScore" class="text-6xl font-black">0</p>
                </div>
                <div class="bg-gray-50 p-8 rounded-xl text-left border flex flex-col justify-center space-y-3 text-sm text-gray-800 text-left">
                    <div class="flex justify-between border-b pb-1 font-bold text-gray-800"><span class="text-gray-500 uppercase text-xs">Benar</span> <span id="correctCount" class="text-green-600">0</span></div>
                    <div class="flex justify-between border-b pb-1 font-bold text-gray-800"><span class="text-gray-500 uppercase text-xs">Salah</span> <span id="wrongCount" class="text-red-600">0</span></div>
                    <div class="flex justify-between font-bold text-gray-800"><span class="text-gray-500 uppercase text-xs">Kosong</span> <span id="unansweredCount" class="text-gray-800">0</span></div>
                </div>
            </div>
            <button onclick="location.reload()" class="bg-gray-900 hover:bg-black text-white px-10 py-4 rounded-xl font-bold transition-all shadow-lg uppercase text-sm text-white">Kembali ke Beranda</button>
        </section>

        <!-- PAGE 5: ADMIN PANEL -->
        <section id="adminPage" class="hidden card-pusmendik p-4 md:p-8 transition-all border fade-in mb-20 text-gray-800 text-left">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4 text-left">
                <div class="text-left">
                    <h2 class="text-2xl font-black tracking-tight uppercase text-gray-800 text-left">Dashboard Administrator</h2>
                    <div class="flex gap-4 mt-2 text-left">
                        <button onclick="setAdminTab('soal')" id="tabBtnSoal" class="text-sm font-bold border-b-2 border-[#003399] text-[#003399] pb-1 transition-all">Kelola Soal</button>
                        <button onclick="setAdminTab('nilai')" id="tabBtnNilai" class="text-sm font-bold border-b-2 border-transparent text-gray-400 pb-1 transition-all">Rekap Nilai</button>
                    </div>
                </div>
                <div id="adminSubjectFilter" class="flex gap-2 text-right">
                    <button onclick="filterAdminSubject('Matematika')" id="btnFilterMat" class="px-4 py-1.5 rounded-lg font-bold text-xs border-2 border-[#003399] bg-[#003399] text-white transition-all">Numerasi</button>
                    <button onclick="filterAdminSubject('Bahasa Indonesia')" id="btnFilterIndo" class="px-4 py-1.5 rounded-lg font-bold text-xs border-2 border-gray-100 text-gray-500 hover:bg-gray-50 transition-all text-gray-700">Literasi</button>
                </div>
            </div>

            <!-- Tab Soal -->
            <div id="adminTabSoal" class="grid grid-cols-1 lg:grid-cols-3 gap-6 text-gray-800 text-left">
                <div class="lg:col-span-1 space-y-4 text-left text-gray-800 text-left">
                    <div class="bg-gray-50 p-5 rounded-xl border border-gray-200 shadow-inner text-left">
                        <div class="flex justify-between items-center mb-4 text-left text-gray-800">
                            <h3 class="font-black text-gray-700 uppercase text-xs text-gray-800">Form Input Soal</h3>
                            <button type="button" onclick="downloadTemplate()" class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-[9px] font-black hover:bg-blue-200 uppercase transition-all">Unduh Template</button>
                        </div>
                        <form id="addQuestionForm" class="space-y-3 text-left">
                            <input type="hidden" id="editId">
                            <input type="hidden" id="qImageUrl">
                            
                            <div class="grid grid-cols-2 gap-2 text-left">
                                <div class="text-left">
                                    <label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase text-gray-500">Tipe</label>
                                    <select id="qType" onchange="toggleFormInputs()" class="w-full p-2 border rounded font-bold text-xs outline-none bg-white text-gray-800">
                                        <option value="pg">PG (Satu)</option>
                                        <option value="pgk">PGK (Banyak)</option>
                                        <option value="bs">BS (B / S)</option>
                                    </select>
                                </div>
                                <div class="text-left">
                                    <label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase text-gray-500">Paket</label>
                                    <select id="qPackage" class="w-full p-2 border rounded font-bold text-xs outline-none bg-white text-gray-800">
                                        <option value="Paket 1">Paket 1</option><option value="Paket 2">Paket 2</option>
                                    </select>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-2 text-left text-gray-800">
                                <div class="text-left">
                                    <label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase text-gray-500 text-gray-800 text-left">Bobot</label>
                                    <input type="number" id="qWeight" value="1" min="1" class="w-full p-2 border rounded font-bold text-xs outline-none focus:ring-1 focus:ring-blue-400 text-gray-700 bg-white text-gray-800">
                                </div>
                                <div class="text-left">
                                    <label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase text-gray-500 text-gray-800 text-left">Gambar</label>
                                    <input type="file" id="qImageFile" accept="image/*" onchange="handleImageUpload(event)" class="text-[9px] w-full cursor-pointer text-gray-800">
                                </div>
                            </div>

                            <div id="imgPreviewBox" class="hidden border rounded bg-white p-1 relative text-gray-800 text-center">
                                <img id="imgPreview" src="" class="max-h-16 mx-auto rounded">
                                <button type="button" onclick="clearImage()" class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full p-0.5 shadow-sm hover:bg-red-600 text-white"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                            </div>

                            <div class="text-left text-gray-800 text-left">
                                <label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase text-gray-500 text-gray-800 text-left">Teks Soal</label>
                                <textarea id="qText" required rows="2" class="w-full p-2 border rounded text-xs outline-none focus:ring-1 focus:ring-blue-400 text-gray-700 bg-white text-gray-800"></textarea>
                            </div>

                            <div id="pgOptions" class="grid grid-cols-2 gap-2 text-left text-gray-800 text-left">
                                <input type="text" id="optA" placeholder="A" class="w-full p-2 border rounded text-[10px] outline-none text-gray-700 bg-white text-gray-800">
                                <input type="text" id="optB" placeholder="B" class="w-full p-2 border rounded text-[10px] outline-none text-gray-700 bg-white text-gray-800">
                                <input type="text" id="optC" placeholder="C" class="w-full p-2 border rounded text-[10px] outline-none text-gray-700 bg-white text-gray-800">
                                <input type="text" id="optD" placeholder="D" class="w-full p-2 border rounded text-[10px] outline-none text-gray-700 bg-white text-gray-800">
                            </div>

                            <div class="text-left text-gray-800 text-left">
                                <label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase text-gray-500 text-gray-800 text-left">Kunci Jawaban</label>
                                <div id="pgAnswer" class="text-left">
                                    <select id="qAnswer" class="w-full p-2 border rounded font-bold text-xs text-blue-600 outline-none bg-white text-blue-600">
                                        <option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option>
                                    </select>
                                </div>
                                <div id="pgkAnswer" class="hidden flex gap-3 bg-white p-2 border rounded text-[10px] font-bold text-gray-700 text-gray-800 text-left">
                                    <label class="flex items-center gap-1 cursor-pointer"><input type="checkbox" name="pgk" value="A"> A</label>
                                    <label class="flex items-center gap-1 cursor-pointer"><input type="checkbox" name="pgk" value="B"> B</label>
                                    <label class="flex items-center gap-1 cursor-pointer"><input type="checkbox" name="pgk" value="C"> C</label>
                                    <label class="flex items-center gap-1 cursor-pointer"><input type="checkbox" name="pgk" value="D"> D</label>
                                </div>
                                <div id="bsAnswer" class="hidden text-left">
                                    <select id="qAnswerBS" class="w-full p-2 border rounded font-bold text-xs text-green-600 outline-none bg-white text-green-600">
                                        <option value="A">Benar</option><option value="B">Salah</option>
                                    </select>
                                </div>
                            </div>

                            <button type="submit" id="submitBtn" class="w-full bg-[#003399] hover:bg-blue-800 text-white font-bold py-2.5 rounded text-xs shadow-md uppercase tracking-wider transition-all transform active:scale-95 text-white">Simpan Soal</button>
                            <button type="button" id="cancelEdit" onclick="resetForm()" class="hidden w-full text-gray-400 font-bold py-1 text-[10px] uppercase hover:text-gray-600 text-gray-400">Batal Edit</button>
                        </form>
                    </div>

                    <div class="bg-green-50 p-5 rounded-xl border border-green-200 space-y-4 shadow-inner text-left text-gray-800">
                        <h3 class="font-black text-green-700 mb-2 uppercase text-xs tracking-widest text-green-700 text-left">Import Massal</h3>
                        <div class="text-left">
                            <p class="text-[9px] font-bold text-green-600 mb-1 uppercase text-green-600 text-left">1. Link Cloud (Google Sheets)</p>
                            <div class="flex gap-1 text-gray-800 text-left">
                                <input type="text" id="gasUrl" placeholder="URL Apps Script" class="flex-1 p-2 border border-green-200 rounded text-[9px] outline-none bg-white text-gray-800">
                                <button onclick="importFromSpreadsheet()" class="bg-green-600 text-white px-2 py-1 rounded text-[9px] font-bold hover:bg-green-700 text-white">Ambil</button>
                            </div>
                        </div>
                        <div class="border-t border-green-100 pt-3 text-left">
                            <p class="text-[9px] font-bold text-green-600 mb-1 uppercase text-green-600 text-left">2. Upload File Lokal (CSV)</p>
                            <input type="file" id="csvFileImport" accept=".csv" onchange="handleCSVImport(event)" class="w-full text-[9px] file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:bg-white file:text-green-700 cursor-pointer text-gray-800">
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-2 space-y-4 text-left text-gray-800 text-left">
                    <div class="flex justify-between items-center text-[10px] font-black text-gray-400 uppercase tracking-widest text-left">
                        <span class="text-gray-500">Database Soal (<span id="adminTotalCount">0</span>)</span>
                        <button onclick="deleteAllQuestions()" class="text-red-500 hover:underline text-left text-red-500 uppercase font-bold text-[9px]">Hapus Semua</button>
                    </div>
                    <div class="overflow-hidden border rounded-xl bg-gray-50 max-h-[600px] overflow-y-auto custom-scroll shadow-inner text-left">
                        <table class="w-full text-left border-collapse text-gray-800 text-left">
                            <thead class="bg-white text-gray-400 text-[9px] uppercase font-bold sticky top-0 shadow-sm text-gray-500">
                                <tr><th class="px-4 py-3">Pkt/Tipe</th><th class="px-4 py-3">Isi Soal</th><th class="px-4 py-3 text-right">Aksi</th></tr>
                            </thead>
                            <tbody id="adminQuestionTable" class="divide-y text-[11px] text-gray-700 text-gray-800 text-left"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tab Nilai -->
            <div id="adminTabNilai" class="hidden space-y-6 text-left text-gray-800 text-left">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-left">
                    <div class="bg-blue-50 p-5 rounded-xl border border-blue-100 text-center shadow-sm text-center"><p class="text-[10px] font-bold text-blue-600 uppercase tracking-widest text-center">Total Peserta</p><p id="statTotalPeserta" class="text-3xl font-black text-blue-800 text-center">0</p></div>
                    <div class="bg-green-50 p-5 rounded-xl border border-green-100 text-center shadow-sm text-center"><p class="text-[10px] font-bold text-green-600 uppercase tracking-widest text-center">Rata-rata Skor</p><p id="statRataSkor" class="text-3xl font-black text-green-800 text-center">0</p></div>
                    <div class="bg-yellow-50 p-5 rounded-xl border border-yellow-100 text-center shadow-sm text-center"><p class="text-[10px] font-bold text-yellow-600 uppercase tracking-widest text-center">Tertinggi</p><p id="statMaxSkor" class="text-3xl font-black text-yellow-800 text-center">0</p></div>
                </div>
                <div class="overflow-hidden border rounded-xl bg-gray-50 max-h-[500px] overflow-y-auto custom-scroll shadow-inner text-left">
                    <table class="w-full text-left border-collapse text-gray-800 text-left">
                        <thead class="bg-white text-gray-400 text-[9px] uppercase font-bold sticky top-0 shadow-sm text-gray-500">
                            <tr><th class="px-4 py-3 text-left">Siswa</th><th class="px-4 py-3 text-left">Mata Uji (Paket)</th><th class="px-4 py-3 text-center">B/S/K</th><th class="px-4 py-3 text-center">Skor</th><th class="px-4 py-3 text-right">Waktu</th></tr>
                        </thead>
                        <tbody id="adminResultsTable" class="divide-y text-[11px] text-gray-700 text-left text-gray-800"></tbody>
                    </table>
                </div>
            </div>
        </section>

    </main>

    <!-- STATUS TOAST -->
    <div id="statusToast" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-full text-sm font-bold shadow-2xl hidden z-[300] items-center gap-3">
        <span id="toastIcon"></span><span id="toastMsg">Pesan</span>
    </div>

    <!-- MODAL: LOGIN ADMIN -->
    <div id="adminLoginModal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-[150] p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl max-w-sm w-full p-8 shadow-2xl text-left">
            <div class="text-center mb-6"><h3 class="text-xl font-black uppercase text-gray-800 tracking-tight text-gray-800">Admin Access</h3></div>
            <div class="space-y-4 text-left">
                <label class="text-[10px] font-bold text-gray-400 uppercase text-gray-800 text-left">Sandi Administrator</label>
                <input type="password" id="adminPass" placeholder="Masukkan Sandi" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-lg text-center font-bold outline-none focus:ring-2 focus:ring-blue-400 text-gray-800">
                <div class="flex gap-2 pt-2 text-center text-gray-700">
                    <button onclick="toggleAdminLogin(false)" class="flex-1 py-3 border rounded-lg font-bold hover:bg-gray-50 transition-all uppercase text-xs tracking-widest text-gray-700 text-gray-800">Batal</button>
                    <button onclick="handleAdminLogin()" class="flex-1 py-3 bg-[#003399] text-white rounded-lg font-bold hover:bg-blue-800 shadow-md transition-all uppercase text-xs tracking-widest text-white">Masuk</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: KONFIRMASI -->
    <div id="confirmModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[100] p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl max-w-sm w-full p-8 shadow-2xl text-center">
            <h3 class="text-lg font-black mb-4 uppercase text-gray-800 text-gray-800" id="confirmTitle">Konfirmasi</h3>
            <p class="text-sm text-gray-500 mb-8 text-gray-600" id="confirmBody">Lanjutkan tindakan ini?</p>
            <div class="flex gap-3">
                <button onclick="closeConfirmModal()" class="flex-1 py-3 border rounded-lg font-bold hover:bg-gray-50 uppercase text-xs text-gray-700 text-gray-800">Tidak</button>
                <button id="confirmBtnAction" class="flex-1 py-3 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 shadow-lg uppercase text-xs text-white">Ya</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, addDoc, updateDoc, deleteDoc, query, orderBy, serverTimestamp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // --- KONFIGURASI FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyAVnubFjkXVpAMIEbrpYCeHO8GORbxak9M",
            authDomain: "tka-sd-2026.firebaseapp.com",
            projectId: "tka-sd-2026",
            storageBucket: "tka-sd-2026.firebasestorage.app",
            messagingSenderId: "990790996833",
            appId: "1:990790996833:web:6095edbdea56971103eb20",
            measurementId: "G-Y07817VBWX"
        };

        // --- KONFIGURASI GOOGLE APPS SCRIPT (Opsional: Isi disini jika ingin permanen) ---
        const DEFAULT_GAS_URL = "https://script.google.com/macros/s/AKfycbzdqRGu3W4Br6SYYOTopdK62TJ4Iup1AtUj0Q194IlFVDSjH0dEEu1kjokUCTsI7Yhkxw/exec"; 

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'tka-sd-online-v3';

        // --- APP STATE ---
        let currentUserObj = null;
        let allQuestions = [];
        let allResults = [];
        let activeQuestions = [];
        let currentIdx = 0;
        let userAnswers = [];
        let doubts = [];
        let selectedSubject = 'Matematika';
        let selectedPackage = 'Paket 1';
        let adminFilterSubject = 'Matematika';
        
        const EXAM_DURATION_MINS = 75;
        const MAX_QUESTIONS_PER_EXAM = 30;
        let timerSeconds = EXAM_DURATION_MINS * 60;
        let timerInterval;

        // --- CORE FUNCTIONS ---

        const initAuth = async () => {
            showLoader(true, "Sinkronisasi Cloud...");
            try {
                const cred = await signInAnonymously(auth);
                currentUserObj = cred.user;
                console.log("Auth Success:", currentUserObj.uid);
            } catch (err) { 
                console.error("Auth error:", err);
                if (err.code === 'auth/configuration-not-found') {
                    showToast("Error: Aktifkan 'Anonymous login' di Firebase Console!", "error");
                } else {
                    showToast("Error Koneksi Cloud: " + err.message, "error");
                }
            } finally { 
                showLoader(false); 
            }
        };

        onAuthStateChanged(auth, (u) => { 
            currentUserObj = u; 
            if (u) { 
                startDataSync(); 
                startResultSync(); 
            } 
        });

        const startDataSync = () => {
            if (!currentUserObj) return;
            const qRef = collection(db, 'artifacts', appId, 'public', 'data', 'questions');
            onSnapshot(qRef, (snapshot) => {
                allQuestions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (!document.getElementById('adminPage').classList.contains('hidden')) renderAdminTable();
            }, (err) => console.error("Question sync fail:", err)); 
        };

        const startResultSync = () => {
            if (!currentUserObj) return;
            const rRef = collection(db, 'artifacts', appId, 'public', 'data', 'results');
            onSnapshot(rRef, (snapshot) => {
                allResults = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (!document.getElementById('adminPage').classList.contains('hidden')) renderResultsTable();
            }, (err) => console.error("Results sync fail:", err));
        };

        // --- VIEW NAVIGATION ---

        window.showView = (viewId) => {
            const views = ['landingPage', 'loginPage', 'examPage', 'resultPage', 'adminPage'];
            views.forEach(v => {
                const el = document.getElementById(v);
                if (el) el.classList.add('hidden');
            });
            const target = document.getElementById(viewId);
            if (target) target.classList.remove('hidden');

            document.getElementById('adminLoginBtn').classList.toggle('hidden', viewId === 'adminPage');
            document.getElementById('exitAdminBtn').classList.toggle('hidden', viewId !== 'adminPage');
            
            if (viewId === 'adminPage') { 
                renderAdminTable(); 
                renderResultsTable(); 
                if (DEFAULT_GAS_URL && !document.getElementById('gasUrl').value) {
                    document.getElementById('gasUrl').value = DEFAULT_GAS_URL;
                }
            }
        };

        window.setAdminTab = (tab) => {
            const isSoal = tab === 'soal';
            document.getElementById('adminTabSoal').classList.toggle('hidden', !isSoal);
            document.getElementById('adminTabNilai').classList.toggle('hidden', isSoal);
            document.getElementById('tabBtnSoal').className = isSoal ? "text-sm font-bold border-b-2 border-[#003399] text-[#003399] pb-1 transition-all" : "text-sm font-bold border-b-2 border-transparent text-gray-400 pb-1 transition-all";
            document.getElementById('tabBtnNilai').className = !isSoal ? "text-sm font-bold border-b-2 border-[#003399] text-[#003399] pb-1 transition-all" : "text-sm font-bold border-b-2 border-transparent text-gray-400 pb-1 transition-all";
            document.getElementById('adminSubjectFilter').classList.toggle('invisible', !isSoal);
        };

        window.goToConfirmation = () => {
            selectedSubject = document.getElementById('subjectSelect').value;
            document.getElementById('displaySubjectName').value = selectedSubject;
            showView('loginPage');
        };

        window.toggleAdminLogin = (show) => document.getElementById('adminLoginModal').style.display = show ? 'flex' : 'none';
        
        window.handleAdminLogin = () => { 
            const pass = document.getElementById('adminPass').value;
            if (pass === 'admin123') { 
                toggleAdminLogin(false); 
                showView('adminPage'); 
                showToast("Akses Administrator Terbuka", "success"); 
            } else {
                showToast("Sandi Salah!", "error"); 
            }
            document.getElementById('adminPass').value = ''; 
        };

        window.filterAdminSubject = (s) => {
            adminFilterSubject = s;
            document.getElementById('btnFilterMat').className = s === 'Matematika' ? 'px-4 py-1.5 rounded-lg font-bold text-xs border-2 border-[#003399] bg-[#003399] text-white transition-all' : 'px-4 py-1.5 rounded-lg font-bold text-xs border-2 border-gray-100 text-gray-500 hover:bg-gray-50 transition-all';
            document.getElementById('btnFilterIndo').className = s === 'Bahasa Indonesia' ? 'px-4 py-1.5 rounded-lg font-bold text-xs border-2 border-[#003399] bg-[#003399] text-white transition-all' : 'px-4 py-1.5 rounded-lg font-bold text-xs border-2 border-gray-100 text-gray-500 hover:bg-gray-50 transition-all';
            renderAdminTable();
        };

        // --- QUESTION MANAGEMENT ---

        window.downloadTemplate = () => {
            const BOM = "\ufeff"; 
            const h = "Soal,Tipe (pg/pgk/bs),Opsi A,Opsi B,Opsi C,Opsi D,Kunci,Mata Uji,Paket (Paket 1/Paket 2),Gambar URL (Opsional),Bobot\n";
            const row1 = '"Contoh: Berapa hasil dari 10 x 5?",pg,40,50,60,70,B,Matematika,Paket 1,,1\n';
            const row2 = '"Manakah yang termasuk hewan berkaki empat?",pgk,Ayam,Kambing,Sapi,Burung,B;C,Literasi,Paket 2,,2\n';
            const blob = new Blob([BOM + h + row1 + row2], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'template_tka_sd.csv'; a.click();
        };

        const renderAdminTable = () => {
            const t = document.getElementById('adminQuestionTable'); t.innerHTML = '';
            const f = allQuestions.filter(q => q.subject === adminFilterSubject);
            document.getElementById('adminTotalCount').innerText = f.length;
            f.sort((a,b) => (b.createdAt || 0) - (a.createdAt || 0)).forEach(q => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="px-4 py-3"><span class="bg-gray-200 text-gray-600 px-1 py-0.5 rounded text-[8px] font-bold">${q.package || 'Pkt 1'}</span><br><span class="bg-blue-100 text-blue-700 px-1 py-0.5 rounded border border-blue-200 uppercase text-[8px] font-bold">${q.type}</span> | <b>${q.weight || 1}</b></td><td class="px-4 py-3 text-gray-600 max-w-[200px] truncate text-left">${q.text}</td><td class="px-4 py-3 text-right space-x-2"><button onclick="editQuestion('${q.id}')" class="text-blue-500 font-bold uppercase hover:underline">Edit</button><button onclick="deleteQuestion('${q.id}')" class="text-red-400 font-bold uppercase hover:underline">Hapus</button></td>`;
                t.appendChild(tr);
            });
        };

        window.handleImageUpload = (e) => {
            const f = e.target.files[0]; if (!f) return;
            if (f.size > 800000) { showToast("Gambar Maks 800KB", "error"); e.target.value = ''; return; }
            const r = new FileReader(); r.onload = (ev) => {
                const b = ev.target.result; document.getElementById('qImageUrl').value = b;
                document.getElementById('imgPreview').src = b; document.getElementById('imgPreviewBox').classList.remove('hidden');
            }; r.readAsDataURL(f);
        };

        window.clearImage = () => { document.getElementById('qImageUrl').value = ''; document.getElementById('imgPreview').src = ''; document.getElementById('qImageFile').value = ''; document.getElementById('imgPreviewBox').classList.add('hidden'); };
        
        window.toggleFormInputs = () => {
            const t = document.getElementById('qType').value;
            document.getElementById('pgOptions').classList.toggle('hidden', t === 'bs');
            document.getElementById('pgAnswer').classList.toggle('hidden', t !== 'pg');
            document.getElementById('pgkAnswer').classList.toggle('hidden', t !== 'pgk');
            document.getElementById('bsAnswer').classList.toggle('hidden', t !== 'bs');
        };

        document.getElementById('addQuestionForm').onsubmit = async (e) => {
            e.preventDefault();
            if (!currentUserObj) {
                showToast("Menunggu Koneksi Cloud...", "error");
                await initAuth();
                if (!currentUserObj) return;
            }
            const qId = document.getElementById('editId').value, t = document.getElementById('qType').value;
            let ans;
            if (t === 'pgk') { ans = Array.from(document.querySelectorAll('input[name="pgk"]:checked')).map(cb => cb.value); if (ans.length === 0) return showToast("Pilih minimal 1 jawaban!", "error"); }
            else if (t === 'bs') ans = document.getElementById('qAnswerBS').value;
            else ans = document.getElementById('qAnswer').value;

            const data = { text: document.getElementById('qText').value, type: t, package: document.getElementById('qPackage').value, weight: parseInt(document.getElementById('qWeight').value) || 1, imageUrl: document.getElementById('qImageUrl').value || "", options: { A: document.getElementById('optA').value || 'Benar', B: document.getElementById('optB').value || 'Salah', C: document.getElementById('optC').value, D: document.getElementById('optD').value }, answer: ans, subject: adminFilterSubject, createdAt: serverTimestamp() };
            showLoader(true, "Menyimpan...");
            try { const ref = collection(db, 'artifacts', appId, 'public', 'data', 'questions'); if (qId) await updateDoc(doc(ref, qId), data); else await addDoc(ref, data); resetForm(); showToast("Berhasil Disimpan", "success"); } catch (err) { showToast("Gagal Simpan: " + err.message, "error"); } finally { showLoader(false); }
        };

        window.editQuestion = (id) => {
            const q = allQuestions.find(it => it.id === id); if (!q) return;
            resetForm(); document.getElementById('editId').value = q.id;
            document.getElementById('qType').value = q.type || 'pg'; toggleFormInputs();
            document.getElementById('qPackage').value = q.package || 'Paket 1';
            document.getElementById('qWeight').value = q.weight || 1;
            document.getElementById('qText').value = q.text;
            document.getElementById('optA').value = q.options.A; document.getElementById('optB').value = q.options.B;
            document.getElementById('optC').value = q.options.C; document.getElementById('optD').value = q.options.D;
            if (q.imageUrl) { document.getElementById('qImageUrl').value = q.imageUrl; document.getElementById('imgPreview').src = q.imageUrl; document.getElementById('imgPreviewBox').classList.remove('hidden'); }
            if (q.type === 'pgk') { const a = Array.isArray(q.answer) ? q.answer : [q.answer]; document.querySelectorAll('input[name="pgk"]').forEach(cb => cb.checked = a.includes(cb.value)); }
            else if (q.type === 'bs') document.getElementById('qAnswerBS').value = q.answer;
            else document.getElementById('qAnswer').value = q.answer;
            document.getElementById('submitBtn').innerText = "UPDATE DATA"; document.getElementById('cancelEdit').classList.remove('hidden');
        };

        window.deleteQuestion = (id) => { openConfirmModal("Hapus Soal?", "Data soal akan dihapus selamanya dari database.", async () => { showLoader(true, "Hapus..."); try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'questions', id)); showToast("Soal Dihapus", "success"); } catch (err) { showToast("Gagal Menghapus", "error"); } finally { showLoader(false); closeConfirmModal(); } }); };

        window.deleteAllQuestions = () => { openConfirmModal("Bersihkan Semua?", "Semua soal di kategori ini akan dihapus dari server.", async () => { showLoader(true, "Proses..."); const f = allQuestions.filter(q => q.subject === adminFilterSubject); for (const q of f) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'questions', q.id)); showToast("Database Bersih", "success"); showLoader(false); closeConfirmModal(); }); };

        window.resetForm = () => { document.getElementById('addQuestionForm').reset(); document.getElementById('editId').value = ''; document.getElementById('submitBtn').innerText = "SIMPAN SOAL"; document.getElementById('cancelEdit').classList.add('hidden'); clearImage(); toggleFormInputs(); };

        // --- IMPORT LOGIC ---

        function parseCSV(text) {
            const result = [];
            const rows = text.split(/\r?\n/);
            for (let i = 1; i < rows.length; i++) {
                if (!rows[i].trim()) continue;
                const cols = [];
                let curr = '', inQ = false;
                for (let j = 0; j < rows[i].length; j++) {
                    const c = rows[i][j];
                    if (c === '"' && rows[i][j+1] === '"') { curr += '"'; j++; }
                    else if (c === '"') inQ = !inQ;
                    else if (c === ',' && !inQ) { cols.push(curr.trim()); curr = ''; }
                    else curr += c;
                }
                cols.push(curr.trim());
                result.push(cols);
            }
            return result;
        }

        window.handleCSVImport = (e) => {
            const f = e.target.files[0]; if (!f) return;
            const r = new FileReader();
            r.onload = async (ev) => {
                showLoader(true, "Mengunggah Data...");
                try {
                    const dataRows = parseCSV(ev.target.result);
                    const qRef = collection(db, 'artifacts', appId, 'public', 'data', 'questions');
                    let count = 0;
                    for (const row of dataRows) {
                        if (row.length < 11) continue;
                        const item = {
                            text: row[0].replace(/^"|"$/g, ''), 
                            type: row[1].toLowerCase(),
                            options: { A: row[2], B: row[3], C: row[4], D: row[5] },
                            answer: row[1].toLowerCase() === 'pgk' ? row[6].split(';') : row[6],
                            subject: row[7],
                            package: row[8],
                            imageUrl: row[9] || "",
                            weight: parseInt(row[10]) || 1,
                            createdAt: serverTimestamp()
                        };
                        await addDoc(qRef, item);
                        count++;
                    }
                    showToast(`${count} Soal Berhasil Diimpor`, "success");
                } catch (err) { showToast("Format CSV Salah!", "error"); }
                finally { showLoader(false); e.target.value = ''; }
            };
            r.readAsText(f);
        };

        window.importFromSpreadsheet = async () => {
            const u = document.getElementById('gasUrl').value.trim() || DEFAULT_GAS_URL;
            if (!u) return showToast("Masukkan URL!", "error");
            showLoader(true, "Tarik Data Cloud...");
            try {
                const resp = await fetch(u); const data = await resp.json();
                const qRef = collection(db, 'artifacts', appId, 'public', 'data', 'questions');
                for (const item of data) {
                    if (item.type === 'pgk' && typeof item.answer === 'string') item.answer = item.answer.split(',').map(s => s.trim().toUpperCase());
                    await addDoc(qRef, { ...item, createdAt: serverTimestamp() });
                }
                showToast("Import Cloud Sukses", "success");
            } catch (err) { showToast("Koneksi Apps Script Gagal", "error"); } finally { showLoader(false); }
        };

        const renderResultsTable = () => {
            const t = document.getElementById('adminResultsTable'); t.innerHTML = '';
            let tot = 0, sum = 0, mx = 0;
            allResults.sort((a,b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0)).forEach(r => {
                tot++; sum += r.score; if(r.score > mx) mx = r.score;
                const tr = document.createElement('tr');
                const dt = r.createdAt ? new Date(r.createdAt.toMillis()).toLocaleDateString('id-ID', {day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit'}) : '-';
                tr.innerHTML = `<td class="px-4 py-3 font-bold text-gray-800 text-xs text-left">${r.name}</td><td class="px-4 py-3 text-gray-500 uppercase font-black text-[8px] text-left">${r.subject} (${r.package || 'Pkt 1'})</td><td class="px-4 py-3 text-xs text-center"><span class="text-green-600 font-bold">${r.correct}</span>/<span class="text-red-500 font-bold">${r.wrong}</span>/<span class="text-gray-400 font-bold">${r.empty}</span></td><td class="px-4 py-3 text-center"><span class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded font-black">${r.score}</span></td><td class="px-4 py-3 text-right text-gray-400 text-[10px]">${dt}</td>`;
                t.appendChild(tr);
            });
            document.getElementById('statTotalPeserta').innerText = tot;
            document.getElementById('statRataSkor').innerText = tot ? Math.round(sum/tot) : 0;
            document.getElementById('statMaxSkor').innerText = mx;
        };

        // --- EXAM LOGIC ---

        window.prepareExam = () => {
            const n = document.getElementById('studentName').value.trim(); if (!n) return showToast("Isi Nama Kamu!", "error");
            if (!currentUserObj) {
                showToast("Menghubungkan ke Cloud...", "error");
                initAuth();
                return;
            }
            
            selectedPackage = Math.random() < 0.5 ? 'Paket 1' : 'Paket 2';
            activeQuestions = allQuestions.filter(q => q.subject === selectedSubject && q.package === selectedPackage);
            
            if (activeQuestions.length === 0) {
                const alt = selectedPackage === 'Paket 1' ? 'Paket 2' : 'Paket 1';
                activeQuestions = allQuestions.filter(q => q.subject === selectedSubject && q.package === alt);
                if (activeQuestions.length > 0) selectedPackage = alt;
            }

            if (activeQuestions.length === 0) return showToast("Soal belum tersedia untuk materi ini!", "error");
            
            // ACAK DAN LIMIT KE 30 SOAL
            activeQuestions = activeQuestions.sort(() => 0.5 - Math.random()).slice(0, MAX_QUESTIONS_PER_EXAM);
            
            userAnswers = activeQuestions.map(q => (q.type === 'pgk' ? [] : null));
            doubts = new Array(activeQuestions.length).fill(false);
            currentIdx = 0;

            document.getElementById('displayStudentName').innerText = n;
            document.getElementById('displaySubjectInfo').innerText = `${selectedSubject} (${selectedPackage})`;
            document.getElementById('currentPackageInfo').innerText = selectedPackage;
            document.getElementById('userInfo').classList.remove('hidden');
            showView('examPage'); renderQuestion(); renderGrid(); startTimer();
        };

        window.renderQuestion = () => {
            const q = activeQuestions[currentIdx];
            document.getElementById('currentNumberText').innerText = currentIdx + 1;
            document.getElementById('questionContent').innerText = q.text;
            const ib = document.getElementById('questionImageBox'), ie = document.getElementById('questionImageDisplay');
            if (q.imageUrl) { ie.src = q.imageUrl; ib.classList.remove('hidden'); } else { ib.classList.add('hidden'); }
            const badge = document.getElementById('questionTypeBadge');
            badge.innerText = q.type === 'pgk' ? "Kompleks" : (q.type === 'bs' ? "Benar / Salah" : "Pilihan Ganda");
            
            const cont = document.getElementById('optionsContainer'); cont.innerHTML = '';
            const ks = (q.type === 'bs') ? ['A', 'B'] : ['A', 'B', 'C', 'D'].filter(k => q.options[k]);
            ks.forEach(k => {
                let s = q.type === 'pgk' ? userAnswers[currentIdx].includes(k) : userAnswers[currentIdx] === k;
                const d = document.createElement('div');
                d.className = `option-card flex items-center p-4 border rounded-xl cursor-pointer transition-all ${s ? 'option-selected shadow' : 'bg-white'}`;
                d.onclick = () => { if (q.type === 'pgk') { const i = userAnswers[currentIdx].indexOf(k); if (i > -1) userAnswers[currentIdx].splice(i, 1); else userAnswers[currentIdx].push(k); } else { userAnswers[currentIdx] = k; } renderQuestion(); renderGrid(); };
                const ic = document.createElement('div');
                ic.className = `w-8 h-8 flex items-center justify-center border-2 font-black mr-4 transition-all ${s ? 'bg-[#003399] border-[#003399] text-white' : 'text-gray-400 border-gray-100'}`;
                if (q.type === 'pgk') { ic.classList.add('rounded'); ic.innerHTML = s ? '' : ''; } else { ic.classList.add('rounded-full'); ic.innerText = k; }
                d.appendChild(ic);
                const l = document.createElement('div'); l.className = `flex-1 font-bold ${s ? 'text-[#003399]' : 'text-gray-600'}`;
                l.innerText = (q.type === 'bs') ? (k === 'A' ? 'Benar' : 'Salah') : q.options[k];
                d.appendChild(l); cont.appendChild(d);
            });
            document.getElementById('btnPrev').disabled = (currentIdx === 0);
            document.getElementById('btnNext').innerText = (currentIdx === activeQuestions.length - 1) ? 'SELESAI' : 'BERIKUTNYA';
            document.getElementById('btnRagu').classList.toggle('btn-ragu-active', doubts[currentIdx]);
            updateProgress();
        };

        window.renderGrid = () => {
            const g = document.getElementById('questionGrid'); g.innerHTML = '';
            activeQuestions.forEach((q, i) => {
                const it = document.createElement('div');
                let st = 'bg-white border text-gray-300';
                const has = q.type === 'pgk' ? userAnswers[i].length > 0 : userAnswers[i] !== null;
                if (has) st = 'status-answered'; if (doubts[i]) st = 'status-doubt';
                if (i === currentIdx) st += ' ring-2 ring-blue-300';
                it.className = `grid-number h-10 flex items-center justify-center rounded font-black text-xs ${st}`;
                it.innerText = i + 1; it.onclick = () => { currentIdx = i; renderQuestion(); renderGrid(); };
                g.appendChild(it);
            });
        };

        window.nextQuestion = () => { if (currentIdx < activeQuestions.length - 1) { currentIdx++; renderQuestion(); renderGrid(); } else confirmFinish(); };
        window.prevQuestion = () => { if (currentIdx > 0) { currentIdx--; renderQuestion(); renderGrid(); } };
        window.toggleDoubtful = () => { doubts[currentIdx] = !doubts[currentIdx]; renderQuestion(); renderGrid(); };
        const updateProgress = () => { const n = activeQuestions.filter((q,i) => q.type === 'pgk' ? userAnswers[i].length > 0 : userAnswers[i] !== null).length; document.getElementById('progressText').innerText = `${n}/${activeQuestions.length}`; };

        const startTimer = () => { 
            timerSeconds = EXAM_DURATION_MINS * 60; 
            clearInterval(timerInterval); 
            timerInterval = setInterval(() => { 
                timerSeconds--; 
                if (timerSeconds <= 0) { 
                    clearInterval(timerInterval); 
                    finishExam(); 
                } 
                const m = Math.floor(timerSeconds/60), s = timerSeconds % 60; 
                document.getElementById('timer').innerText = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`; 
            }, 1000); 
        };

        window.confirmFinish = () => openConfirmModal("Akhiri Tes?", "Kirim semua jawaban kamu sekarang ke database?", finishExam);
        
        window.finishExam = async () => {
            clearInterval(timerInterval); closeConfirmModal();
            if (!currentUserObj) {
                showToast("Koneksi terputus. Mencoba menghubungkan ulang...", "error");
                await initAuth();
                if (!currentUserObj) return;
            }

            let c=0, w=0, e=0, twc=0, twa=0;
            activeQuestions.forEach((q, i) => {
                const ans = userAnswers[i], weight = q.weight || 1;
                twa += weight;
                if (q.type === 'pgk') {
                    if (ans.length === 0) e++;
                    else { const ck = Array.isArray(q.answer) ? q.answer : [q.answer]; const ok = ans.length === ck.length && ans.every(v => ck.includes(v)); if (ok) { c++; twc += weight; } else w++; }
                } else { if (!ans) e++; else if (ans === q.answer) { c++; twc += weight; } else w++; }
            });
            const sc = twa > 0 ? Math.round((twc/twa)*100) : 0;
            document.getElementById('finalScore').innerText = sc;
            document.getElementById('correctCount').innerText = c; document.getElementById('wrongCount').innerText = w; document.getElementById('unansweredCount').innerText = e;
            showView('resultPage');
            const resData = { name: document.getElementById('studentName').value, subject: selectedSubject, package: selectedPackage, correct: c, wrong: w, empty: e, score: sc, createdAt: serverTimestamp() };
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'results'), resData);
                console.log("Firebase Save OK");
                
                const gUrl = document.getElementById('gasUrl').value.trim() || DEFAULT_GAS_URL;
                if (gUrl) {
                    fetch(gUrl, { 
                        method: 'POST', 
                        mode: 'no-cors', 
                        body: JSON.stringify(resData) 
                    }).then(() => console.log("Spreadsheet Send Attempt OK"));
                }
            } catch (err) { 
                console.error("Save fail:", err); 
                document.getElementById('resultMsg').innerText = "Gagal simpan ke database: " + err.message;
            }
        };

        // --- UI HELPERS ---

        window.openConfirmModal = (t, b, a) => { document.getElementById('confirmTitle').innerText = t; document.getElementById('confirmBody').innerText = b; document.getElementById('confirmBtnAction').onclick = a; document.getElementById('confirmModal').style.display = 'flex'; };
        window.closeConfirmModal = () => document.getElementById('confirmModal').style.display = 'none';
        window.showToast = (m, t) => { const toast = document.getElementById('statusToast'); toast.className = `fixed bottom-6 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full text-sm font-bold shadow-2xl flex items-center gap-3 z-[300] fade-in ${t==='error'?'bg-red-600 text-white':'bg-gray-900 text-white'}`; document.getElementById('toastMsg').innerText = m; document.getElementById('toastIcon').innerHTML = t==='error'?'':''; toast.style.display = 'flex'; setTimeout(() => toast.style.display='none', 3000); };
        window.showLoader = (s, t="Proses...") => { document.getElementById('loader').classList.toggle('hidden', !s); document.getElementById('loaderText').innerText = t; };
        window.changeFontSize = (c) => { document.getElementById('questionContent').className = `text-gray-800 leading-relaxed mb-10 min-h-[100px] ${c}`; };

        // INITIALIZE
        initAuth();

        // Export functions to global window
        window.toggleAdminLogin = toggleAdminLogin;
        window.handleAdminLogin = handleAdminLogin;
        window.closeConfirmModal = closeConfirmModal;
        window.toggleFormInputs = toggleFormInputs;
        window.handleCSVImport = handleCSVImport;
        window.importFromSpreadsheet = importFromSpreadsheet;
        window.downloadTemplate = downloadTemplate;
        window.prevQuestion = prevQuestion;
        window.nextQuestion = nextQuestion;
        window.toggleDoubtful = toggleDoubtful;
        window.changeFontSize = changeFontSize;
        window.confirmFinish = confirmFinish;
        window.editQuestion = editQuestion;
        window.deleteQuestion = deleteQuestion;
        window.deleteAllQuestions = deleteAllQuestions;
    </script>
</body>
</html>
